name: build
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  REPO: 'aseprite/aseprite'
  SKIA_DIR: ${{ github.workspace }}\skia
  SKIA_LIBRARY_DIR: ${{ github.workspace }}\skia\out\Release-x64
  SKIA_LIBRARY: ${{ github.workspace }}\skia\out\Release-x64\skia.lib
  BUILD_PATH: 'D:/a/aseprite-windows/aseprite-windows/build/bin'
  UPLOAD_RELEASE: true
jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        os: [windows-latest]
        build_type: [Release]
        enable_ui: [on]
        include:
          - os: windows-latest
            build_type: Release
            enable_ui: on
    steps:
    - name: Get latest aseprite/aseprite release tag
      id: aseprite_release
      shell: bash
      run: |
        latest_tag=$(curl -s https://api.github.com/repos/aseprite/aseprite/releases/latest | jq -r .tag_name)
        my_latest_tag=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases | jq -r '.[0].tag_name')
        if [[ "$latest_tag" == "$my_latest_tag" ]]; then
          echo "skip_build=true" >> $GITHUB_OUTPUT
          exit 0
        else
          echo "aseprite_tag=$latest_tag" >> $GITHUB_OUTPUT
          echo "skip_build=false" >> $GITHUB_OUTPUT
        fi
    - name: Stop if no new release
      if: steps.aseprite_release.outputs.skip_build == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          core.setFailed('No new version. Stopping the build.');
    - uses: actions/checkout@v3
      with:
        repository: ${{ env.REPO }}
        ref: ${{ steps.aseprite_release.outputs.aseprite_tag }}
        submodules: 'recursive'

    - name: Setup Ninja
      uses: seanmiddleditch/gha-setup-ninja@v4

    - name: Setup Skia (download pre-built)
      run: |
        curl -L -o skia.zip https://github.com/aseprite/skia/releases/download/m124-08a5439a6b/Skia-Windows-Release-x64.zip
        7z x skia.zip -oskia

    - name: Setup MSVC environment
      uses: ilammy/msvc-dev-cmd@v1

    - name: Configure with CMake
      run: |
        mkdir build
        cd build
        cmake -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DLAF_BACKEND=skia -DSKIA_DIR="${{ env.SKIA_DIR }}" -DSKIA_LIBRARY_DIR="${{ env.SKIA_LIBRARY_DIR }}" -DSKIA_LIBRARY="${{ env.SKIA_LIBRARY }}" ..

    - name: Build
      run: |
        cd build
        ninja aseprite

    - uses: actions/upload-artifact@v4
      with:
        name: aseprite-windows
        path: |
          ${{ env.BUILD_PATH }}/data
          ${{ env.BUILD_PATH }}/aseprite.exe
    - name: Generate release tag
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        7z a ${{ env.BUILD_PATH }}/aseprite.7z ${{ env.BUILD_PATH }}/data ${{ env.BUILD_PATH }}/aseprite.exe
        echo "::set-output name=release_tag::${{ steps.aseprite_release.outputs.aseprite_tag }}"
        touch release.txt
        echo "Aseprite ${{ steps.aseprite_release.outputs.aseprite_tag }}" >> release.txt
    - name: Upload build to release
      uses: softprops/action-gh-release@v1
      if: steps.tag.conclusion == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: |
          ${{ env.BUILD_PATH }}/aseprite.7z 
